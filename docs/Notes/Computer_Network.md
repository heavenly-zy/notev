# Computer Network <Badge text="alpha" type="warn"/> <Badge text="6.9.0"/>

## 1 概述

### 1.1 互联网的组成

1. 边缘部分
   1. C/S 包含 B/S
   2. P2P
2. 核心部分
   由路由器连接，进而实现分组交换

### 1.2 各种交换的特点

1. 电路交换
   在通话的全部时间内，童话的两个用户始终占用端到端的通信资源
2. 分组交换
   1. 数据报
      易于重复或者丢失 但由于易于搭建 所以采用的更多
   2. 虚电路
      类似于地图的路线规划，同一链路可属于多个虚电路，不独占物理线路
      -  虚电路携带数据：
         1. 路径
         2. 编号
         3. 路由表
      -  分组 HEAD 携带编号

-  虚电路与电路交换的比较：
   虚电路是逻辑连接，非专用，每个结点到其他结点可有无数虚电路

### 1.3 计算机网络的性能

#### 1.3.1 计算机的性能指标

1. 速率
2. 带宽
   频带宽度，数字信道所能传送的“最高数据率”
3. 吞吐量
   单位时间通过某个网络的数据量，受制于网络带宽和额定速率，也即其为实际值，带宽速率为额定值
   另外其取决于整个链路中吞吐量最低的链路
4. 时延
   1. 发送时延
      数据帧长度/发送速率
   2. 传播时延
      信道长度/电磁波在信道的传播速率
   3. 处理时延
      存储转发
   4. 排队时延
      队列等待，与网络中当前数据量相关
      每增加一个中间 Node 就会增加一个发送时延
5. 时延带宽积
   传播时延 x 带宽
   第一个分组到达下一个节点时候信道内的数据
6. 利用率
   利用率过高会产生非常大的时延

### 1.4 网络计算研究与应用的发展

### 1.5 计算机网络的体系结构

#### 1.5.1 网络协议的概念

三要素：语法 语义 时序

#### 1.5.2 网络体系结构的研究方法

1. 层次 （layer）
2. 接口（interface）
3. 各层要完成的功能
   1. 差错控制
   2. 流量控制
   3. 分段和重装
   4. 复用和分用
   5. 连接建立和释放
      分层**缺点**：**同一功能会在不同的层次中重复出现**

#### 1.5.3 层次模型

路由器只实现到网络层

1. OSI 七层协议
2. TCP/IP 四层协议
3. 五层协议
   1. 物理层（physical layer)
      bit
   2. 数据链路层 （data link layer）
      frame(帧) 差错检测
   3. 网络层 （network layer）
   4. 传输层 （transport layer）
      端到端 检测数据包错误和次序
   5. 应用层 （application layer）
      > 每层不需要知道下一层的细节

## 2 物理层

### 2.1 基本概念

#### 2.1.1 数据（Data）

#### 2.1.2 信号（Signal）

1. 模拟信号
2. 数字信号

### 2.2 数据传输类型与通信方式

-  基本问题

1. 类型
   1. 模拟通信
   2. 数字通信
2. 通信方式
   1. 串行 并行
   2. 单工 全双工 半双工
3. 同步方式
   1. 同步 为解决时钟频率问题可以让发送方发送时钟脉冲，更好的方法是采用曼彻斯特编码
   2. 异步
      以字符为单位传输，前后分别加起始位和停止位

#### 2.1.3 传输介质的主要类型

-  有线传输介质
   1. 双绞线
   2. 同轴电缆
   3. 光纤
-  无线传输介质
   1. 无线电波
   2. 微波
   3. 卫星

### 2.2 物理层与物理层协议的基本概念

通信子网分为：点对点与广播信道
广域网主要用点对点，城域网与局域网主要用广播

### 2.3 数据编码技术

#### 2.3.1 数字数据的模拟信号

1. 幅移键控
2. 频移键控
3. 相移键控

#### 2.3.2 数字数据的数据信号

1. 非归零码
2. 曼彻斯特编码 优点：本身携带时钟周期；消除直流分量 缺点：频率增加一倍，导致失真会严重，需要降低信道容量，原理参见 2.4.2-1
3. 差分曼彻斯特编码

#### 2.3.3 模拟数据的数字信号

脉冲编码调制（PCM） 采样量化编码

### 2.4 基带传输技术

#### 2.4.1 基带传输的定义

脉冲波可以由傅里叶展开，分布在各个频率上

#### 2.4.2 信道的极限容量

1. 带宽
   如果不限制的增大频率，那么傅里叶展开的高频分量便增多，在信道上会被过滤掉的也更多，失真很大，很难恢复
2. 信噪比
   香农公式 指出了**信道的极限信息传输速率**

### 2.5 多路复用技术

#### 2.5.1 时分复用

如果某个结点没有数据需要发送，那么信道资源会浪费
这就衍生出来统计时分多路复用，需要增加标识 ID（地址）

#### 2.5.2 频分复用

#### 2.5.3 波分复用

#### 2.5.4 码分复用

每个站有一个 m bit 的码片序列，各结点码片序列正交，1 传原码 0 传反码 代价：传输 m 倍数据，只能说使得信号可以分离，但并不能说效率增高了

## 3 数据链路层

解决了适配器间的交互问题，而且只在相邻结点之间

### 3.1 使用点对点信道的数据链路层

#### 3.1.1 数据链路和帧

1. 链路 无源点对点的物理线路段
2. 数据链路 物理链路+通信协议
   协议需要使用网卡

-  以**帧**为单位

#### 3.1.2 三个基本问题

1. 封装成帧
   添加首部（SOH）与尾部（EOT）以进行帧定界，数据部分小于等于 MTU
2. 透明传输
   在数据中出现的控制字符和转义字符前加转义字符（ESC），就类似 C 等中的“\”转义啦
3. 差错检测
   比特差错 利用循环冗余检验(CRC)
   帧的丢失、重复、失序并不能检测出来，故不是可靠传输

### 3.2 点对点协议 PPP

#### 3.2.1 PPP 协议的特点

1. 简单——这是首要的要求
2. 封装成帧
3. 透明性
4. 多种网络层协议
5. 多种类型链路
6. 差错检测
7. 检测连接状态
8. 最大传送单元
9. 网络层地址协商
10.   数据压缩协商

#### 3.2.2 PPP 协议不需要的功能

1. 纠错
2. 流量控制
3. 序号
4. 多点线路
5. 半双工或单工链路

#### 3.2.3 PPP 协议的组成

#### 3.2.4 PPP 协议的帧格式

1. 各字段意义
   7E FF 03 协议 信息部分 FCS 7E
2. 字符填充 用于异步传输
   增加转义字符
3. 零比特填充 用于同步传输
   一旦出现连续 5 个 1 就插入一个 0
   > 可靠传输的权衡
   > 由于出错率较低，并不需要在数据链路层完成，可交由更高层完成（比如 TCP）

#### 3.2.5 PPP 协议的工作状态

### 3.3 使用广播信道的数据链路层

#### 3.3.1 局域网的数据链路层

1. 拓扑
   1. 星型网 中央结点出问题全网瘫痪
   2. 环形网 类似链表，结点插入与删除较麻烦
   3. 总线网 较为方便，采用较多
2. 媒体共享技术
   1. **静态**划分信道
      1. 频分复用
      2. 时分复用
      3. 波分复用
      4. 码分复用
         静态，并不适合
   2. 动态媒体接入控制
      1. 随机接入
      2. 受控接入
3. 数据链路层的两个子层
   1. 逻辑链路控制 LLC
   2. 媒体接入控制 MAC
4. 适配器的作用
   1. 串并转换
   2. 数据进行缓存
   3. 需要驱动程序
   4. 实现以太网协议

#### 3.3.2 CSMA/CD 协议

1. 措施
   1. 无连接 不编号
   2. 曼彻斯特编码
2. 协议方式
   1. Aloha
   2. 信道监听
   3. 冲突后停止发送，等待随机时间后重传
      故 CSMA/CD 使用多点接入载波监听碰撞检测这样的协议
3. 重要特性
   1. 半双工
4. 争用期 2τ(51.2μs)
   重传以 2τ 为单位，从$0~2^k-1$选一个数
5. 帧间最小间隔 9.6μs
6. 强化碰撞 人为干扰信号

#### 3.3.3 以太网的信道利用率

1. 减小 τ
2. 增大帧长，但不能超过 MTU

#### 3.3.4 以太网的 MAC 层

1. MAC 层的硬件地址
   固化在适配器 ROM 中
   前 24 位为厂家标志，后 24 位厂家自行分配 适配器对帧进行检查
2. MAC 帧的格式
   目的地址 源地址 类型 数据(46-1500B) FCS
   > 没特别做透明传输机制的原因：
       1 曼彻斯特编码，可识别有无信号
       2 帧间有间隔
3. 无效的 MAC 帧 丢掉就好(╯‵□′)╯︵┻━┻

### 3.4 扩展的局域网

#### 3.4.1 在物理层扩展以太网

利用集线器互连，但使得碰撞域也更大了，吞吐量并未提高，而且需要各碰撞域使用相同数据率

#### 3.4.2 在数据链路层扩展以太网

**网桥**

1. 内部结构
   **网桥的接口就是结点**
   没有扩展碰撞域，用户独占带宽 1. 优点 1. 用户独占带宽 2. 可以使用不同数据率 2. 缺点 1. 存储转发时延 2. 无流量控制 3. 广播风暴
2. 透明网桥
   1. 利用**自学习算法**，可以根据帧的源地址和来源接口建立表，同时记录一个有效时间，以保证各结点变化时可以继续正常工作
   2. 使用生成树算法避免兜圈子
3. 以太网交换机
   1. 就是多接口的网桥，每个接口都直接与主机相连，一般是全双工
   2. 星型拓扑，不需要 CSMA/CD，不需要竞争资源，效率更高

### 3.5 无线局域网(WLAN)

#### 3.5.1 无线局域网的组成

1. 基本服务集 BSS
2. 接入点 AP
3. 扩展的服务集 ESS

-  与接入点 AP 建立关联

   -  被动扫描
   -  主动扫描

-  常用 802.11 无线局域网

#### 3.5.2 无线局域网标准 IEEE 802.11

1. 帧间间隔 IFS 根据优先级设置帧间间隔，高优先级帧间间隔短，最短的间隔大于端到端时延
2. 链路层确认
   CRC 校验，并返回确认帧，若未收到则重传
3. CSMA/CA 协议
   因为无法检测碰撞，故使用**退避算法**以降低碰撞几率
   只有第一帧且信道空闲不执行退避算法，此外全部需要使用退避算法
4. 解决隐蔽站和暴露站问题
   1. 虚拟载波监听
   2. 想发送数据前先发送 RTS（包含时间），接受站发送 CTS（包含时间）
   3. 短数据帧代价有点大，不使用也可
5. 802.11 局域网的 MAC 帧
   1. 数据帧
      1. 要有序号，以配合确认机制
      2. 除去传输帧站点 MAC 和接收帧站点 MAC，还需要一个真正的源地址或者目的地址（emmmm，也不一定，有路由器的话就不是真正的咯）
      3. 没有冲突检测，故数据部分不需要够 46 字节
      4. 分片机制，不限制 MTU 可以增加灵活性，在信道质量好的时候可以传输长一些，而质量差的时候进行分片传输短的数据帧；整个帧的占用时间是所有分片占用时间的加和
   2. 控制帧
   3. 管理帧

## 4 网络层

### 4.1 网络层提供的两种服务

数据报或者虚电路

> 有人按照电信网提出了虚电路的方法，这就需要提前建立链路，之后就可以进行比较可靠的传输了，但是计算机网络其实是有着很强的差错处理能力的，所以它并不需要过高的可靠性，可将错误处理等任务交由上层处理，这样有一个好处就是大大提升了网络层的灵活性

#### 4.1.1 虚拟互联网络

因为各个网络间有着各种各样的协议等等问题，而要做到各个网络标准完全一致又是不可能的，因此网络之间的互连就成了一个问题

一般来说，各层间的中间设备分别是：

-  物理层： 转发器
-  数据链路层： 网桥
-  网络层： 路由器
-  网络层以上： 网关

由于我们讨论的是网络层，所以在该层上看，转发器与网桥对网络的互连其实仅仅是将一个网络扩大了，还是在一个网络上；所以我们讨论网络的互连一般指路由器对网络的互连

### 4.2 IP 地址

#### 4.2.1 地址结构

网络号+主机号，可加快转发效率

#### 4.2.2 分类

根据前几位可分为 5 类
A 类 0
B 类 10
C 类 110
D 类 1110 多播
E 类 1111 保留

#### 4.2.3 RFC 保留的地址

专用网络内 专有或私有的地址块

#### 4.2.4 网络接口与 IP 地址的关系

每个接口都有 IP

#### 4.2.5 IP 地址的一些重要特点

1. 是一种分等级的地址结构
2. 每个接口都有一个 IP，所以，有多个接口接入网络的主机会是多归属主机
3. 用转发器或者网桥互连是在同一个网络，路由器才能连接不同网络
4. 同一网络号所有 IP 是平等的

#### 4.2.6 子网和超网的基本概念

传统的分配方法会造成 IP 地址的浪费

1. 子网 将大的网络分成几个较小的网络 IP = 网络号 + 子网号 + 主机号
   1. 由于从 IP 数据报中无法知道该主机所连接的网络是否进行子网划分，所以使用子网掩码对 IP 地址的子网部分进行标记
   2. 网络号与子网号均置 1，主机号置 0
   3. 判断两主机是否在同一子网，只需要 IP 与子网掩码与运算就好啦，但是两个结点的子网掩码不同可能导致判断不同的，所以可能会出现 A 认为 B 和自己在同一子网，而 B 认为 A 和自己不在同一子网的情况
2. 超网 无分类域间路由 CIDR
   1. 不进行 ABC 的分类，只需要网络前缀即可(相当于只有子网掩码)
   2. 可利用斜线记法表示，对应掩码 1 的个数
   3. 路由聚合（路由聚合有利于减少路由器之间的路由选择信息的交换，从而提高了整个互联网的性能）

#### 4.2.7 专用 IP 地址与网络地址转换 NAT 技术

-  专用 IP 地址仅仅在机构内部使用，是不可能出现在网络上的

   -  三个专用 IP 地址块：

      -  10.0.0.0 - 10.255.255.255
      -  172.16.0.0 - 172.31.255.255
      -  192.168.0.0 - 192.168.255.255

   -  虚拟专用网 VPN

      利用公用的互联网作为本机构各专用网之间的通信载体，由于通过公用的互联网，所以数据必须加密

      利用隧道技术（通过公用网的时候，将专用网内 IP 数据报封装入数据部分，首部写入公网 IP 等信息）

      ![CN02](../Images/CN02.png)

-  路由器上有一个 IP 的转换表，在传输层有对**端口号**的管理，从而确定路由器发送到哪个内部结点

### 4.3 网际协议 IP

#### 4.3.1 IP 数据报结构

版本 首部长度 区分服务 总长度 标识 标志 片偏移 生存时间 协议 首部检验和 源地址 目的地址 可变部分

> 标识、标志、片偏移三个字段的存在可以保证分片可以正常组装，标识位区分是否是同一个帧的分片、标志标明是否使用分片和分片是否到了最后一片、片偏移标志了顺序（字节为单位）

> 低于 46 字节的填充是在网络层完成而不是数据链路层，可由总长度区分数据与填充部分

> 协议字段决定交由上层哪个协议

### 4.4 IP 层转发分组的流程

转发（forwarding）是将分组从一个输入链路接口转移到正确的输出链路端口

#### 4.4.1 默认路由（default route）

将所有未知网络聚合成一个表项

#### 4.4.2 分组转发算法

1. 首部提取目的主机 IP 地址 D，得出目的网络地址 N

```Python
N = D & Netmask
```

2. 与直接相连各网络地址匹配

```Python
if D in Adjacent:
    直接交付
    break
else:
    间接交付(call(3))
```

3. 特定主机路由匹配

```Python
if D in route:
    送至下一跳路由
    break
else:
    call(4)
```

4. 网络匹配

```Python
if N in route:
    送至下一跳路由
    break
else:
    call(5)
```

5. 默认路由

```Python
if hasDefaultRoute:
    送至默认路由器
    break
else:
    call(6)
```

6. 报告转发分组出错

```Python
raise IPError
```

> 如果多项匹配，那么按照匹配的更多的进行转发（子网），这样转发是最优的路径

### 4.5 地址解析

IP 地址与硬件地址

#### 4.5.1 ARP 协议

解决**同一个局域网**上的主机或路由器的 IP 地址和硬件地址的映射问题
源结点喊（请求，广播帧）一下 IPxxx 的是谁，目的结点把他的 Mac 地址反馈（应答，单播即可）过去，然后生成一张表，另外有一个更新时间戳，以便更新

#### 4.5.2 为何不用硬件地址通信

因为网络发展初期，硬件地址格式并不统一

#### 4.5.3 Examples

-  AB 经网桥互连
   源 IP|目的 IP|源 MAC|目的 MAC
   ---|---|---|---
   A|B|A|B
   A|B|A|B
-  AB 经路由器相连
   源 IP|目的 IP|源 MAC|目的 MAC
   ---|---|---|---
   A|B|A|router
   A|B|router|B

#### 4.5.4 Others

ARP 只经过链路层，不经过网络层封装

### 4.6 网际控制报文协议 ICMP

用来提高交付成功的机会，它允许主机或路由器报告差错情况和提供有关异常情况的报告

#### 4.6.1 ICMP 的种类

-  ICMP 差错报告报文 收到有问题的报文的主机或路由器向源主机或路由器发送
   -  终点不可达
   -  时间超过
   -  参数问题
   -  改变路由（重定向）
-  ICMP 询问报文
   -  回送请求和回答
   -  时间戳请求和回答

#### 4.6.2 ICMP 应用举例

-  `ping`
-  `traceroute`(UNIX) 、 `tracert`(Windows)

### 4.7 路由器

最高处理到网络层

#### 4.7.1 输入到输出

打碎，重构网络层首部；相对的，网桥并不打碎链路层首位部

#### 4.7.2 交换结构

将分组从一个输入端口转移到正确的输出端口

1. 内存读写 需要解决内存读写速度
2. 总线结构 需要解决总线的竞争
3. 互联网络 crossbar 可多个端口同时输出

#### 4.7.3 分组丢弃

1. 当输入侧带宽较高时，路由器处理速率较低，将会导致输入侧缓存满，无法继续存入分组，只能丢弃
2. 当采用一定的加速比时，输出侧处理速度无法与输出侧处理速度相匹配，输出侧缓存满，也会导致分组被丢弃

### 4.8 Internet 的路由选择协议

#### 4.8.1 路由算法分类

-  全局性/分布式
-  静态路由选择策略/动态路由选择策略

#### 4.8.2 分层次的路由选择协议

因特网采用分层次的路由选择协议

#### 4.8.3 自治系统 AS

在相同管理控制下的一组路由器

-  内部网关协议 IGP
   -  RIP
   -  OSPF
-  外部网关协议 EGP
   -  BGP

#### 4.8.4 内部网关协议 RIP

1. 分布式 距离向量
2. 路由表的建立
   -  开始只知道相邻的路由信息（距离为 1）
   -  每个路由器只和相邻路由器交换并更新路由信息
   -  若干次更新后……该自制系统的路由信息就都知道了
   -  RIP 协议收敛过程比较慢
3. RIP 的工作过程
   -  收到相邻路由器的路由表，将*该路由表*的下一跳更新，距离加一，该更新是无条件的（因为这不是最终的路由表，更新保证了时效性）
   -  与自己的路由表比较，小则替换，大则 pass
   -  若 3min 收不到该路由器的路由表，则判断该路由器宕掉了
4. 三个要点
   -  相邻路由器交换
   -  交换的信息是当前路由器所知道的*全部信息*
   -  按固定的时间间隔交换路由信息（30s）
5. 优缺点
   1. 某个路由器的故障信息传播较慢
   2. 实现简单，开销较小
   3. 限制了网络的规模使用的最大距离为 15
   4. 路由器之间交换的路由信息是完整的路由表，随着网络规模增大，开销将会增加

#### 4.8.5 最短路径优先协议 OSPF

1. 基本特点
   -  开放
   -  最短路径优先 （ Dijkstra 算法）
   -  分布式的链路状态协议
2. 三个要点
   -  向本自治系统所有路由器发送信息
   -  发送与本路由器相邻所有路由器的链路状态（与谁相连与链路的度量（就是权重，比如带宽、时延等））
   -  只有链路状态变化时才需要更新
3. 链路状态数据库
   就是储存的拓扑结构信息
4. OSPF 的区域
   1. 如果自治系统很大，那么需要对自治系统划分为一个个区域（area）
   2. 每个区域有一个 32 位标志符（点分十进制）
   3. 区域不能太大，最好一个区域不超过 200 个路由器
   4. 两种区域：主干区域、其它
5. OSPF 直接用 IP 数据报传送
   1. 不用 UDP，直接用 IP 数据报，而 RIP 是需要先封装成 UDP 协议的
   2. 数据报很短，可减少路由信息的通信量
   3. 不需要分片
   4. 但分片传送的数据包只要丢失一个就无法组装成原来的数据报，整个数据报要重传
6. 其他特点
   1. 可以根据不同链路的类型计算不同的路由
   2. 多路径间的负载平衡
   3. 所有在 OSPF 路由器之间交换的分组都具有鉴别的功能
   4. 支持可变长度的子网划分和五分类编址 CIDR
   5. 每个链路状态都带上一个 32 位的序号
   6. OSPF 每隔一段时间要刷新链路状态
7. OSPF 的五种分组类型
   -  问候
   -  数据库描述
   -  链路状态请求
   -  链路状态更新
   -  链路状态确认
8. OSPF 的基本操作
   ![CN01](../Images/CN01.png)
   另外， OSPF 使用的是**可靠的洪泛法**发送更新分组
9. 优缺点
   -  当互联网规模很大时，OSPF 协议要比 RIP 协议好得多
   -  OSPF 没有坏消息传得慢的问题，收敛比较快

#### 4.8.6 边界网关协议 BGP

1. 使用环境

不同 AS 间的路由选择协议

> 为什么不能使用内部网关协议（RIP/OSPF）？
>
> -  互联网规模太大，使得自治系统 AS 之间的路由选择非常困难（交换完整信息需要庞大数据库，计算最短路径需花费大量时间），因此 BGP 协议使用交换“可达性”信息
> -  自治系统 AS 之间的路由选择必须考虑有关策略（考虑到政治、安全、荆棘等因素）
>
> 综合上述理由， BGP 只能是力求寻找一条**能够到达目的网络且比较好的路由**（不能兜圈子），而**并非要寻找一条最佳路由**

2. BGP 发言人

每个 AS 至少有一个 BGP 发言人（BGP speaker）

-  交换路由信息

   BGP 发言人之间建立 TCP 连接，从而交换路由信息

3. BGP 协议的特点

   -  BGP 协议交换路由信息的结点数量级是自治系统数的量级，这要比这些自治系统中的网络数少很多
   -  每一个自治系统中 BGP 发言人（或边界路由器）的数目是很少的，这样就使得自治系统之间的路由选择不致过分复杂
   -  BGP 支持 CIDR
   -  在 BGP 刚刚运行时，BGP 的邻站是交换整个的 BGP 路由表。但以后**只需要在发生变化时更新有变化的部分**，这样做对节省网络带宽和减少路由器的处理开销都有好处

4. BGP-4 的四种报文
   -  OPEN
   -  UPDATE
   -  KEEPALIVE
   -  NOTIFICATION

### 4.9 IPv6

IPv4 的 32 位地址空间已经不足，IPv6 的 128 位地址空间在可预见的未来是用不尽的

#### 4.9.1 IPv6 的基本首部

仍支持无连接的传送

主要变化：

-  更大的地址空间
-  扩展的地址层次结构
-  灵活的首部格式
-  改进的选项
-  允许协议继续扩充
-  支持即插即用（即自动配置）
-  支持资源的预分配
-  IPv6 首部改为 8 字节对齐

#### 4.9.2 IPv6 的地址

-  IPv6 的数据报的目的地址可以是以下三种基本类型地址之一

   -  单播
   -  多播
   -  任播

-  IPv6 的记法（冒号十六进制记法）：

   -  零压缩（只能进行一次）
   -  点分十进制法的后缀

#### 4.9.3 IPv4 向 IPv6 的过渡

逐步演进

-  双协议栈 部分主机（或路由器）同时装有两个协议栈（IPv4、IPv6）
-  隧道技术 当 IPv6 数据报进入 IPv4 网络时，将数据报封装成 IPv4 数据报

#### 4.9.4 ICMPv6

相当于 IPv4 中的 ICMP、IGMP、ARP 的合并版，其为面向报文的协议，利用报文来报告差错、获取信息

### 4.10 IP 多播

可以更好地支持一对多通信（向 90 个主机发送数据需要 90 次单播，如果多播只需要一次）

#### 4.10.1 网际组管理协议 IGMP

使路由器知道多播组成员的信息

1. 加入多播组

   主机向多播组的多播地址发送 IGMP 报文

2. 探询组成员变化情况

   多播路由器周期探询本地局域网上的主机，以便知道他们是否还活跃

#### 4.10.2 多播路由选择协议

使路由器和互联网上的其他多播路由器协同工作，一边宝多播数据报用最小代价传送给所有的组成员

多播路由选择实际上就是要找出以源主机为根结点的多播转发树

-  洪泛与剪除
-  隧道技术 在不支持多播的网络上加上首部重新封装后传输
-  基于核心的发现技术

### 4.11 多协议标记交换 MPLS

#### 4.11.1 MPLS 的工作原理

由于每次分组到达一个路由器后都需要抽取目的地址、查路由表后转发，所以当网络流量很大时会花费很多时间，故在 MPLS 域入口处给每个数据报打上一定长度的“标记”，之后**对打上标记的 IP 数据报使用硬件进行转发**，离开 MPLS 域时去掉标记

#### 4.11.2 MPLS 首部的位置与格式

位置在网络层与数据链路层之间，从层次的角度看，MPLS 在第二层和第三层之间

## 5 运输层

- 运输层为相互通信的==应用进程==提供逻辑通信
- TCP 面向连接， UDP 无连接
- 差错检测

### 5.1 运输层协议概述

#### 5.1.1 进程之间的通信

![CN03](../Images/CN03.png)

运输层向它上面的应用层提供通信服务，它属于**面向通信部分的最高层，同时也是用户功能的最底层**

值得注意的是，只有网络边缘的主机的协议栈才有运输层，网络核心部分的路由器只到网络层，所以在运输层来看，就像主机与主机之间直接的通讯，但是……

端到端的通信其实是是应用进程之间的通信，并不是主机之间的

#### 5.1.2 基于端口的复用与分用

![CN04](../Images/CN04.png)

- 发送方不同的应用进程的数据可以封装在同一个运输层协议中，此称为**复用**
- 接收方的运输层在剥去报文的首部后能够将这些数据正确交付给目的应用进程，此称为**分用**

#### 5.1.3 两个主要协议

- 传输控制协议 TCP
   - 面向连接
   - 全双工可靠信道
   - 传输单位： TCP 报文段
- 用户数据报协议 UDP
   - 无连接
   - 不可靠信道
   - 传输单位： UDP 用户数据报

> 一些网络层协议与运输层协议的对应关系
> ![CN05](../Images/CN05.png)

#### 5.1.4 运输层的端口

> 这里的端口指的是软件端口

由于我们在运输层完成的是进程之间的通信，那么应用层所完成的主机之间的通信就显得不够了，这就需要我们在运输层协议首部加上各个进程的一个代号，这个任务就由端口号（软件端口）来完成了，当然，头部里源端口号和目的端口号都要写上，具体关系可参考 5.1.2 下的图

用 16 位端口号来标志一个端口，也就是每台主机有 65535 个端口，当然这对一台计算机来说是够用的

MAC IP 和端口号之于计算机网络就类似于地址、门牌号和姓名之于邮政系统（个人理解，参考如下）

> 《计算机网络》 第七版 谢希仁 P121
> （原文太长，缩减）实际上 IP 地址标志一台主机（或路由器）和一条链路的**接口**，当一台主机同时连接到多个网络上时，那么它在每个网络上都应有一个 IP，此时称其为**多归属主机**，由于路由器一定连接着多个网络，所以路由器是有着多个 IP 的，这就相当于某个在北京路与上海路交叉口的建筑，它应当有两个门牌号（北京路 1 号和上海路 4 号）
>
> 很明显，这里的接口是指硬件层次上的，也就是**硬件端口**

> 《计算机网络》 第七版 谢希仁 P206
> （结合课件，修改）我们知道运输层有着复用与分用的功能，复用就相当于某户人家将所有的信件同时投递在同一个邮箱，而分用就相当于该户人家从信箱中取出所有邮件，并按照姓名分给每个人
>
> 我们知道这里的端口是指软件层面的，每个人的姓名相当于一个**软件端口**

- 端口号的分类
   - 服务器使用的端口号
      - 熟知端口号 0~1023
      - 系统端口号 1024~49151
   - 客户端使用的端口号
      又称**短暂端口号**，客户端程序以某端口号向服务器发送消息，服务器收到消息后向该端口号返回响应，通信结束后该端口便不再占用，可由其他进程使用

### 5.2 用户数据报协议 UDP

#### 5.2.1 UDP 概述

只在 IP 数据包服务的基础上增加了很少的功能

- 增加的功能
   - 复用和分用（上节说了）
   - 差错检测（我们前几层都只做了很基本的差错检测，所以还是很不可靠的）

- UDP 的特点
   - 无连接
   - 尽最大努力交付（不保证可靠）
   - 面向报文（每个应用层报文加个首部就可以作为网络层的数据了，不对应用层报文拆分和合并，每个应用层报文对应一个 UDP 用户数据报）
   - 没有拥塞控制（不会因为网络的拥塞而降低源主机的发送速率，很适合实时应用）
   - 支持一对一、一对多、多对一和多对多的交互通信
   - UDP 的首部开销小

当然，既然不可靠就一定会有对策，这就需要应用进程本身增加些提高可靠性的措施（应该就是应用层的事了，也就是我们需要考虑的问题了）

#### 5.2.2 UDP 的首部格式

![CN06](../Images/CN06.png)

**伪首部只在计算检验和的时候使用，既不向上递交，也不向下传送**

UDP 中计算检验和的时候**首部和数据部分**都检验，IP 数据报只检验其首部

### 5.3 传输控制协议 TCP 概述

#### 5.3.1 TCP 最主要的特点

- 面向连接
- 点对点（每一条 TCP 连接只能有两个端点）
- 可靠交付（无差错、不丢失、不重复）
- 全双工（两端都有缓存，两端应用程序只需要向各自缓存内读写数据即可，其他由 TCP 完成）
- 面向字节流（TCP 将数据看作一连串无结构的字节流）

#### 5.3.2 TCP 的连接

TCP 连接的端点是套接字 Socket

Socket =  IP : port

如 106.14.169.129:1017

### 5.4 可靠传输的工作原理

理想传输：
- 传输信道不产生差错
- 不管发送方以多快的速度发送数据，接收方总是来得及处理收到的数据

但是理想是不可能的，所以我们就需要采取一些措施：
- 出现差错时让发送方重传出现差错的数据
- 在接收方来不及处理收到的数据时，及时告诉发送方适当降低发送数据的速度

#### 5.4.1 停止等待协议

发送方每发送一个分组就停止发送，等待接收方返回确认，收到确认后才传下一个分组

发送方对每个分组有一个超时计时器，若**计时时间内未收到分组则重传**

- 确认丢失
   接收方向发送方发送的确认丢失了，那么发送方必然会重传，然后接收方又收到重复的分组，则丢弃，然后再次发送确认

- 确认迟到
   接收方向发送方发送的确认迟到了，发送方当然也会重传啦，然后接收方又收到重复的分组，然后丢弃，发送方也会因此收到两个确认，其中一个就不管啦，反正已经确认过啦

很明显，这种方法信道利用率很低，每个分组都要等待返回确认才能继续下一组的发送，因此可利用流水线运输来提高信道利用率

- 特点
   - 停止等待
   - 编号
   - 自动重传请求
   - 简单，但信道利用率太低

#### 5.4.2 连续 ARQ 协议

![CN07](../Images/CN07.png)

窗口内的可以发送，每收到确认，窗口向前滑动

- 累计确认
   每次确认收到的最后一个分组即可

   - 优点
      容易实现
   - 缺点
      可能出现回退的情况

- 发送方接收方分别设有发送窗口和接收窗口

### 5.5 TCP 报文段的首部格式

![CN08](../Images/CN08.png)

- 源端口
- 目的端口
- 序号（以字节编码，比如某个分组序号为 301 ，长度 100 bytes，那么下一个分组序号就是 401）
- 确认号（期待的下一个分组序号，比如接收到了 301 分组，长度 100 bytes，那么期待 401）
   > 若确认号 = N，则表明：到序号 N-1位置的所有数据都已正确收到
- 数据偏移
- 保留
- 紧急 URG
- 确认 ACK
- 推送 PSH
- 复位 RST
- 同步 SYN
- 终止 FIN
- 窗口
- 检验和
- 紧急指针
- 选项

### 5.6 TCP 可靠传输的实现

#### 5.6.1 以字节为单位的滑动窗口

![CN09](../Images/CN09.png)

发送方窗口由接收方所发来的确认报文段所构建（确认号 + 窗口）

要有累积确认能力，故确认有一定的推迟时间

#### 5.6.2 超时重传时间的选择

根据报文段的往返时间 RTT 来计算，这里使用滑动平均值

$RTT_S = (1 - \alpha) \times RTT_S + \alpha \times RTT$

（这里直接使用 $C$ 语言的赋值语句了，用旧值替换新值，不是恒等式）

另外设置超时重传时间 $RTO = RTT_S + 4 \times RTT_D$

这里 $RTT_D$ 是偏差的滑动平均值……

另外，值得注意的是当出现出现重传的情况下可能出现一个问题就是，收到的确认到底是对哪次发送的确认，如果认为是第一次，$RTT_S$ 会偏大，那么之后重传时间会变大，如果发生此情况比较多， $RTT_S$ 就会持续增大，反之， $RTT_S$ 减小，会导致重传次数增加，$RTT_S$ 持续减小

一种比较好的算法是，当出现重传的时候，$RTO$ 都变大些（通常取两倍）

#### 5.6.3 选择确认 SACK

收到的字节块不连续，确认的时候增加该字段可防止发送方把某些已经收到的字节块重传

### 5.7 TCP 的流量控制

#### 5.7.1 利用滑动窗口实现流量控制

![CN10](../Images/CN10.png)

利用滑动窗口可以很容易的实现流量控制

另外要注意的就是死锁（接收端有了新的空间，提出新的可接受窗口，但不幸的是此消息丢失，两端都傻等着），可利用持续计时器解决

#### 5.7.2 TCP 的传输效率

- 当发送数据较少，数据部分就占得较少，利用率较低
- 接收方刚空出来缓存空间就让接收方扩大窗口，可能扩大的量并不多，发送方只能发很少的数据

前者可用 $Nagle$ 优化，后者可让接收方等待一段时间再确认（养肥了再……）

### 5.8 TCP 的拥塞控制

流量控制是针对接收端缓存满的情况，而拥塞控制是针对整个网络上的主机和路由器缓存满的情况

#### 5.8.1 拥塞控制的一般原理

出现拥塞的原因： $\sum$ 对资源的需求 > 可用资源

> 值得注意的是，增加资源并不能解决拥塞

#### 5.8.2 TCP 的拥塞控制方法

- 慢开始
- 拥塞避免

![CN11](../Images/CN11.png)

- 快重传 发送方只要一连收到三个重复确认，就知道接收方确实没有收到报文段，因而应当立即进行重传，这样就不会出现超时，发送方也不就会误认为出现了网络拥塞
- 快恢复 当发送端收到连续三个重复的确认时，由于发送方现在认为网络很可能没有发生拥塞，因此现在不执行慢开始算法，而是执行快恢复算法

#### 5.8.3 主动队列管理 AQM

如果路由器队列满了会将后来的丢失，而这些分组可能来自不同的 TCP 连接，这就使得网络上同时进入慢开始状态，之后又会同时增大通信量（全局同步）

所以，应当在路由器队列尚未满的时候提早将部分分组丢失，其中一种实现方法是随机早期检测 RED

### 5.9 TCP 的运输连接管理

- 连接建立
- 数据传送
- 连接释放

#### 5.9.1 TCP 的连接建立

三报文握手

![CN12](../Images/CN12.png)

- 客户端向服务器请求连接
- 服务器发送同意连接
- 客户端发送确认

#### 5.9.2 TCP 的连接释放

四报文握手

![CN13](../Images/CN13.png)

- 客户端向服务器发送请求释放，进入半关闭状态
- 服务器发送确认，并继续发送剩余数据
- 服务器将剩余数据传输完后向客户端发送请求释放
- 客户端发送确认

#### 5.9.3 TCP 的有限状态机

![CN14](../Images/CN14.png)

## 6 应用层

每个应用层协议都是为了解决某一类应用问题，而问题的解决又往往是通过位于不同主机中的多个应用进程之间的通信和协同工作来完成的

应用层的具体内容就是规定应用进程在通信时所遵循的协议

### 6.1 域名系统 DNS

#### 6.1.1 域名系统概述

用于解析域名与其对应的 IP 地址

采用分布式的域名系统 DNS

需要若干的域名服务器，DNS 解析报文使用 UDP 以减小开销

#### 6.1.2 互联网的域名结构

树状结构： n 级域名.$\cdots$.三级域名.二级域名.顶级域名

- 顶级域名分类
   - 国家顶级域名 nTLD
      - us
      - jp
      - cn
      - uk
      - $\cdots$
   - 通用顶级域名 gTLD
      - com
      - net
      - org
      - $\cdots$
   - 基础结构顶级域名 用于反向域名解析
      - arpa

#### 6.1.3 域名服务器

将域划分为区，每个区内一个域名服务器

每个域名服务器都应建立缓存以提高查询效率

- 本地域名服务器

   客户端缓存如果没有对应域名，则向本地域名服务器查询（递归查询），本地服务器若没有对应缓存，则代为查询（迭代查询）

- 根域名服务器

   本地域名服务器无法解析时首先求助于根域名服务器，当根域名服务器无法解析时，会告诉本地服务器应该向哪个顶级域名服务器查询

   使用任播技术

- 顶级域名服务器（TLD 服务器）

   当顶级域名服务器仍无法解析该域名的时候，会告诉本地服务器应该向哪个权限域名服务器查询，依此迭代

- 权限域名服务器

   就是各个区的域名服务器

具体查询过程可参加下图

![CN15](../Images/CN15.png)

### 6.2 文件传送协议

#### 6.2.1 FTP 概述

存取、修改都需要先从服务器下载其副本，操作后重传

#### 6.2.2 FTP 的基本工作原理

使用两个 TCP 连接（控制连接和数据连接）

#### 6.2.3 简单文件传送协议 TFTP

使用 UDP ，简单

### 6.3 远程终端协议 TELNET

利用 TCP ，用户好像直接连接到远程主机上，可以直接通过该协议操作远程主机（仅限命令）

为了适应各系统的差异，所以命令需预先编码成 NVT 格式，然后在服务器解码后执行

### 6.4 万维网 WWW

#### 6.4.1 万维网概述

万维网 WWW（World Wide Web）
统一资源定位符 URL（Uniform Resource Locator）
超文本传输协议 HTTP（HyperText Transfer Protocol）

#### 6.4.2 统一资源定位符 URL

<协议> :// <主机>:<端口>/<路径>

（HTTP 默认 80 端口）

#### 6.4.3 超文本传输协议 HTTP

- HTTP 的操作过程

   使用面向连接的 TCP 连接，但其本身是无连接的，并不建立 HTTP 连接

   - 无连接 HTTP本身无连接
   - 无状态 每次访问和第一次访问相同

   但这样就有一个问题，每个 Request 都需要建立一次 TCP 连接，这就需要三握手，花费 $RTT \times 2$ 的时间

   HTTP1.1 针对该问题进行优化，使用持续连接
      - 非流水线方式
      - 流水线方式

- 代理服务器

   代理服务器上建立缓存，以提高访问速度

- HTTP 的报文结构

   - 请求报文
      - METHOD URL VERSION
      - 之后一系列字段的 KEY : VALUE
      > e.g.
      >
      > GET http://www.xyz.edu.cn/dir/index.htm HTTP/1.1
      > Host: www.xyz.edu.cn
      > Connection: close
      > User-Agent: Mozilla/5.0
      > Accept-Language: cn

   - 响应报文
      - VERSION STATUS_CODE 短语
      - 之后一系列字段的 KEY : VALUE
      > e.g.
      >
      > HTTP/1.1 301 Moved Permanently
      > Location: http://www.xyz.edu/ee/index.html

- 在服务器上存放用户的信息

   解决某些应用场景下无状态无法满足需求的问题，使用 Cookie

#### 6.4.4 万维网的文档

- 超文本标记语言 HTML

   HTML（HyperText Markup Language）
   XML（Extensible Markup Language） 可扩展标记语言 用来传输数据的，正在被 JSON 所取代
   XHTML （Extensible HTML） 可扩展超文本标记语言 用来扩展 HTML ，现在也不见踪影了
   CSS （Cascading Style Sheets） 层叠样式表

- 动态万维网文档

   服务器上动态生成（本文档的编译版就是静态文档，用 Django 写的就是动态文档）

- 活动万维网文档

   文档内嵌入脚本（现在主流 JS）

#### 6.4.5 万维网的信息检索系统

   - 全文检索搜索 比如百度
   - 分类目录搜索 比如新浪网

#### 6.4.6 社交网站

SNS（Social Networking Site）

### 6.5 电子邮件

#### 6.5.1 电子邮件概述

使用 TCP

#### 6.5.2 简单邮件传送协议 SMTP

#### 6.5.3 电子邮件的信息格式

首部
- To
- Subject
- Cc
- From
- Date
- Reply-To

#### 6.5.4 邮件读取协议 POP3 和 IMAP

- 邮局协议 POP （当前第三个版本 POP3）
- 网际报文存取谐音 IMAP （当前第四个版本 IMAP4，但通常直接称为 IMAP）

#### 6.5.5 基于万维网的电子邮件

用户使用 HTTP 协议与邮件服务器传送邮件，但邮件服务器之间仍使用 SMTP 传送

#### 6.5.6 通用互联网邮件扩充 MIME

因为 SMTP 只能传输 ASCII 码（每个 7bit）的数据，所以传输其它数据需要经过编码，转换成 ASCII 码再传输

比如针对二进制数据的 base64 编码（每 6bit 转换成一个 ASCII 码）

### 6.6 动态主机配置协议 DHCP

为了免去为需要连接网络的设备逐个配置 IP 、子网掩码等信息的麻烦，DHCP 应运而生

- 即插即用，非常适合经常变换网络的设备
- 使用 UDP
- 每个网络使用一个 DHCP 中继代理，以降低 DHCP 服务器的数量
- IP 是有租用期的，当租用期过了一半需请求更新租用期

### 6.7 简单网络管理协议 SNMP

网络管理包裹对硬件、软件和人力的使用、综合与协调，以便对网络自言进行监视、测试、配置、分析、评价和控制，这样就能以合理的价格满足网络的一些需求，如实时运行性能、服务质量等

其包含了

- SNMP 本身
- 管理信息结构 SMI
- 管理信息库 MIB

### 6.8 应用进程跨越网络的通信

系统调用 （system call）
应用编程接口 API （Application Programming Interface）

![CN16](../Images/CN16.png)

当然，UDP 服务器由于只提供无连接服务，因此不适用 listen 和 accept 系统调用

### 6.9 P2P 应用

资源并不存储在服务器上，服务器上只存储资源的索引，资源存储在用户主机上

# Extends

1. wireshark 抓包工具
2. [QQ 是基于 UDP 还是 TCP](https://zhidao.baidu.com/question/136592671.html)

# Amendant Record

1. 180913 #1 Finished
2. 180918 #2 Finished
3. 181009 #3 Finished
4. 190226 #4 Finished
5. 190303 #5 Finished
6. 190308 #6 Finished

# Reference

1. 申彦明老师课程
2. [《计算机网络》及其配套课件 谢希仁](http://yx.51zhy.cn/net.jsp)

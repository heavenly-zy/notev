<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0/katex.min.css">

# Computer Network <Badge text="alpha" type="warn"/> <Badge text="4.7.5"/>

## 1 概述
### 1.1 互联网的组成
1. 边缘部分
    1. C/S 包含B/S
    2. P2P
2. 核心部分  
由路由器连接，进而实现分组交换

### 1.2 各种交换的特点
1. 电路交换
    在通话的全部时间内，童话的两个用户始终占用端到端的通信资源
2. 分组交换
    1. 数据报  
        易于重复或者丢失 但由于易于搭建 所以采用的更多
    2. 虚电路  
        类似于地图的路线规划，同一链路可属于多个虚电路，不独占物理线路  
        * 虚电路携带数据：  
            1. 路径
            2. 编号
            3. 路由表  
        * 分组HEAD携带编号
* 虚电路与电路交换的比较：
    虚电路是逻辑连接，非专用，每个结点到其他结点可有无数虚电路
        

### 1.3 计算机网络的性能
#### 1.3.1 计算机的性能指标
1. 速率  
2. 带宽  
频带宽度，数字信道所能传送的“最高数据率”
3. 吞吐量  
单位时间通过某个网络的数据量，受制于网络带宽和额定速率，也即其为实际值，带宽速率为额定值  
另外其取决于整个链路中吞吐量最低的链路
4. 时延
    1. 发送时延  
    数据帧长度/发送速率
    2. 传播时延  
    信道长度/电磁波在信道的传播速率
    3. 处理时延  
    存储转发
    4. 排队时延  
    队列等待，与网络中当前数据量相关  
    每增加一个中间Node就会增加一个发送时延
5. 时延带宽积  
传播时延x带宽  
第一个分组到达下一个节点时候信道内的数据
6. 利用率  
利用率过高会产生非常大的时延

### 1.4 网络计算研究与应用的发展

### 1.5 计算机网络的体系结构
#### 1.5.1 网络协议的概念  
三要素：语法 语义 时序
#### 1.5.2 网络体系结构的研究方法
1. 层次 （layer）
2. 接口（interface）
3. 各层要完成的功能
    1. 差错控制
    2. 流量控制
    3. 分段和重装
    4. 复用和分用
    5. 连接建立和释放  
    分层**缺点**：**同一功能会在不同的层次中重复出现**

#### 1.5.3 层次模型  
路由器只实现到网络层
1. OSI七层协议
2. TCP/IP四层协议
3. 五层协议
    1. 物理层（physical layer)  
        bit 
    2. 数据链路层 （data link layer）  
        frame(帧) 差错检测
    3. 网络层 （network layer）
    4. 传输层 （transport layer）  
        端到端 检测数据包错误和次序
    5. 应用层 （application layer）  
    > 每层不需要知道下一层的细节

## 2 物理层
### 2.1 基本概念
#### 2.1.1 数据（Data）

#### 2.1.2 信号（Signal）
1. 模拟信号
2. 数字信号

### 2.2 数据传输类型与通信方式
* 基本问题
1. 类型
    1. 模拟通信
    2. 数字通信
2. 通信方式
    1. 串行 并行
    2. 单工 全双工 半双工
3. 同步方式
    1. 同步   为解决时钟频率问题可以让发送方发送时钟脉冲，更好的方法是采用曼彻斯特编码
    2. 异步  
    以字符为单位传输，前后分别加起始位和停止位

#### 2.1.3 传输介质的主要类型
* 有线传输介质
    1. 双绞线
    2. 同轴电缆
    3. 光纤
* 无线传输介质
    1. 无线电波
    2. 微波
    3. 卫星

### 2.2 物理层与物理层协议的基本概念  
通信子网分为：点对点与广播信道  
广域网主要用点对点，城域网与局域网主要用广播

### 2.3 数据编码技术  
#### 2.3.1 数字数据的模拟信号
1. 幅移键控
2. 频移键控
3. 相移键控

#### 2.3.2 数字数据的数据信号  
1. 非归零码
2. 曼彻斯特编码 优点：本身携带时钟周期；消除直流分量 缺点：频率增加一倍，导致失真会严重，需要降低信道容量，原理参见2.4.2-1
3. 差分曼彻斯特编码

#### 2.3.3 模拟数据的数字信号
脉冲编码调制（PCM） 采样量化编码

### 2.4 基带传输技术
#### 2.4.1 基带传输的定义  
脉冲波可以由傅里叶展开，分布在各个频率上

#### 2.4.2 信道的极限容量  
1. 带宽  
如果不限制的增大频率，那么傅里叶展开的高频分量便增多，在信道上会被过滤掉的也更多，失真很大，很难恢复  
2. 信噪比  
香农公式 指出了**信道的极限信息传输速率**

### 2.5 多路复用技术
#### 2.5.1 时分复用  
如果某个结点没有数据需要发送，那么信道资源会浪费  
这就衍生出来统计时分多路复用，需要增加标识ID（地址）

#### 2.5.2 频分复用

#### 2.5.3 波分复用

#### 2.5.4 码分复用  
每个站有一个m bit的码片序列，各结点码片序列正交，1传原码0传反码   代价：传输m倍数据，只能说使得信号可以分离，但并不能说效率增高了

## 3 数据链路层
解决了适配器间的交互问题，而且只在相邻结点之间
### 3.1 使用点对点信道的数据链路层
#### 3.1.1 数据链路和帧  
1. 链路 无源点对点的物理线路段
2. 数据链路 物理链路+通信协议  
协议需要使用网卡
* 以**帧**为单位

#### 3.1.2 三个基本问题
1. 封装成帧  
添加首部（SOH）与尾部（EOT）以进行帧定界，数据部分小于等于MTU
2. 透明传输  
在数据中出现的控制字符和转义字符前加转义字符（ESC），就类似C等中的“\”转义啦
3. 差错检测  
比特差错 利用循环冗余检验(CRC)  
帧的丢失、重复、失序并不能检测出来，故不是可靠传输

### 3.2 点对点协议PPP
#### 3.2.1 PPP协议的特点
1. 简单——这是首要的要求
2. 封装成帧
3. 透明性
4. 多种网络层协议
5. 多种类型链路
6. 差错检测
7. 检测连接状态
8. 最大传送单元
9. 网络层地址协商
10. 数据压缩协商

#### 3.2.2 PPP协议不需要的功能
1. 纠错
2. 流量控制
3. 序号
4. 多点线路
5. 半双工或单工链路

#### 3.2.3 PPP协议的组成

#### 3.2.4 PPP协议的帧格式
1. 各字段意义  
7E FF 03 协议 信息部分 FCS 7E
2. 字符填充 用于异步传输  
增加转义字符
3. 零比特填充 用于同步传输
一旦出现连续5个1就插入一个0
> 可靠传输的权衡  
由于出错率较低，并不需要在数据链路层完成，可交由更高层完成（比如TCP）

#### 3.2.5 PPP协议的工作状态

### 3.3 使用广播信道的数据链路层
#### 3.3.1 局域网的数据链路层
1. 拓扑  
    1. 星型网 中央结点出问题全网瘫痪
    2. 环形网 类似链表，结点插入与删除较麻烦
    3. 总线网 较为方便，采用较多
2. 媒体共享技术
    1. **静态**划分信道
        1. 频分复用
        2. 时分复用
        3. 波分复用
        4. 码分复用  
        静态，并不适合
    2. 动态媒体接入控制
        1. 随机接入
        2. 受控接入
3. 数据链路层的两个子层  
    1. 逻辑链路控制LLC  
    2. 媒体接入控制MAC
4. 适配器的作用
    1. 串并转换
    2. 数据进行缓存
    3. 需要驱动程序
    4. 实现以太网协议

#### 3.3.2 CSMA/CD协议
1. 措施
    1. 无连接 不编号
    2. 曼彻斯特编码
2. 协议方式
    1. Aloha
    2. 信道监听
    3. 冲突后停止发送，等待随机时间后重传  
    故CSMA/CD使用多点接入载波监听碰撞检测这样的协议
3. 重要特性
    1. 半双工
4. 争用期 2τ(51.2μs)  
重传以2τ为单位，从$0~2^k-1$选一个数
5. 帧间最小间隔9.6μs
6. 强化碰撞 人为干扰信号

#### 3.3.3 以太网的信道利用率
1. 减小τ
2. 增大帧长，但不能超过MTU

#### 3.3.4 以太网的MAC层
1. MAC层的硬件地址  
固化在适配器ROM中  
前24位为厂家标志，后24位厂家自行分配 适配器对帧进行检查
2. MAC帧的格式  
目的地址 源地址 类型 数据(46-1500B) FCS  
> 没特别做透明传输机制的原因：
    1 曼彻斯特编码，可识别有无信号  
    2 帧间有间隔
3. 无效的MAC帧 丢掉就好(╯‵□′)╯︵┻━┻

### 3.4 扩展的局域网
#### 3.4.1 在物理层扩展以太网
利用集线器互连，但使得碰撞域也更大了，吞吐量并未提高，而且需要各碰撞域使用相同数据率

#### 3.4.2 在数据链路层扩展以太网
**网桥**  
1. 内部结构  
**网桥的接口就是结点**  
没有扩展碰撞域，用户独占带宽
    1. 优点
        1. 用户独占带宽
        2. 可以使用不同数据率
    2. 缺点
        1. 存储转发时延
        2. 无流量控制
        3. 广播风暴
2. 透明网桥
    1. 利用**自学习算法**，可以根据帧的源地址和来源接口建立表，同时记录一个有效时间，以保证各结点变化时可以继续正常工作
    2. 使用生成树算法避免兜圈子
3. 以太网交换机
    1. 就是多接口的网桥，每个接口都直接与主机相连，一般是全双工
    2. 星型拓扑，不需要CSMA/CD，不需要竞争资源，效率更高

### 3.5 无线局域网(WLAN)
#### 3.5.1 无线局域网的组成
1. 基本服务集BSS
2. 接入点AP
3. 扩展的服务集ESS

- 与接入点AP建立关联
    * 被动扫描
    * 主动扫描

- 常用802.11无线局域网

#### 3.5.2 无线局域网标准IEEE 802.11
1. 帧间间隔IFS   根据优先级设置帧间间隔，高优先级帧间间隔短，最短的间隔大于端到端时延
2. 链路层确认  
CRC校验，并返回确认帧，若未收到则重传
3. CSMA/CA协议  
因为无法检测碰撞，故使用**退避算法**以降低碰撞几率  
只有第一帧且信道空闲不执行退避算法，此外全部需要使用退避算法
4. 解决隐蔽站和暴露站问题
    1. 虚拟载波监听
    2. 想发送数据前先发送RTS（包含时间），接受站发送CTS（包含时间）
    3. 短数据帧代价有点大，不使用也可
5. 802.11局域网的MAC帧
    1. 数据帧
        1. 要有序号，以配合确认机制
        2. 除去传输帧站点MAC和接收帧站点MAC，还需要一个真正的源地址或者目的地址（emmmm，也不一定，有路由器的话就不是真正的咯）
        3. 没有冲突检测，故数据部分不需要够46字节
        4. 分片机制，不限制MTU可以增加灵活性，在信道质量好的时候可以传输长一些，而质量差的时候进行分片传输短的数据帧；整个帧的占用时间是所有分片占用时间的加和
    2. 控制帧
    3. 管理帧

## 4 网络层
### 4.1 网络层提供的两种服务
数据报或者虚电路
### 4.2 IP地址
#### 4.2.1 地址结构
网络号+主机号，可加快转发效率

#### 4.2.2 分类
根据前几位可分为5类  
A类 0  
B类 10  
C类 110  
D类 1110  多播  
E类 1111  保留  

#### 4.2.3 RFC保留的地址
专用网络内 专有或私有的地址块

#### 4.2.4 网络接口与IP地址的关系
每个接口都有IP

#### 4.2.5 IP地址的一些重要特点
1. 是一种分等级的地址结构
2. 每个接口都有一个IP，所以，有多个接口接入网络的主机会是多归属主机
3. 用转发器或者网桥互连是在同一个网络，路由器才能连接不同网络
4. 同一网络号所有IP是平等的

#### 4.2.6 子网和超网的基本概念
传统的分配方法会造成IP地址的浪费  
1. 子网 将大的网络分成几个较小的网络 IP = 网络号 + 子网号 + 主机号
    1. 由于从IP数据报中无法知道该主机所连接的网络是否进行子网划分，所以使用子网掩码对IP地址的子网部分进行标记
    2. 网络号与子网号均置1，主机号置0
    3. 判断两主机是否在同一子网，只需要IP与子网掩码与运算就好啦，但是两个结点的子网掩码不同可能导致判断不同的，所以可能会出现A认为B和自己在同一子网，而B认为A和自己不在同一子网的情况
2. 超网 无类域间路由CIDR
    1. 不进行ABC的分类，只需要网络前缀即可(相当于只有子网掩码)
    2. 可利用斜线记发表示，对应掩码1的个数
    3. 路由聚合

#### 4.2.7 专用IP地址与网络地址转换NAT技术
- 专用IP地址是不可能出现在网络上的
- 路由器上有一个IP的转换表，在传输层有对**端口号**的管理，从而确定路由器发送到哪个内部结点

### 4.3 网际协议IP
#### 4.3.1 IP数据报结构
版本 首部长度 区分服务 总长度 标识 标志 片偏移 生存时间 协议 首部检验和 源地址 目的地址 可变部分 
> 标识、标志、片偏移三个字段的存在可以保证分片可以正常组装，标识位区分是否是同一个帧的分片、标志标明是否使用分片和分片是否到了最后一片、片偏移标志了顺序（字节为单位）

> 低于46字节的填充是在网络层完成而不是数据链路层，可由总长度区分数据与填充部分

> 协议字段决定交由上层哪个协议

### 4.4 IP层转发分组的流程
转发（forwarding）是将分组从一个输入链路接口转移到正确的输出链路端口

#### 4.4.1 默认路由（default route）
将所有未知网络聚合成一个表项

#### 4.4.2 分组转发算法
1. 首部提取目的主机IP地址D，得出目的网络地址N
```Python
N = D & Netmask
```
2. 与直接相连各网络地址匹配
```Python
if D in Adjacent:
    直接交付
    break
else:
    间接交付(call(3))
```
3. 特定主机路由匹配
```Python
if D in route:
    送至下一跳路由
    break
else:
    call(4)
```
4. 网络匹配
```Python
if N in route:
    送至下一跳路由
    break
else:
    call(5)
```
5. 默认路由
```Python
if hasDefaultRoute:
    送至默认路由器
    break
else:
    call(6)
```
6. 报告转发分组出错
```Python
raise IPError
```

> 如果多项匹配，那么按照匹配的更多的进行转发（子网），这样转发是最优的路径

### 4.5 地址解析
IP地址与硬件地址  
#### 4.5.1 ARP协议
解决**同一个局域网**上的主机或路由器的IP地址和硬件地址的映射问题  
源结点喊（请求，广播帧）一下IPxxx的是谁，目的结点把他的Mac地址反馈（应答，单播即可）过去，然后生成一张表，另外有一个更新时间戳，以便更新    

#### 4.5.2 为何不用硬件地址通信
因为网络发展初期，硬件地址格式并不统一  

#### 4.5.3 Examples
* AB经网桥互连
    源IP|目的IP|源MAC|目的MAC
    ---|---|---|---
    A|B|A|B
    A|B|A|B
* AB经路由器相连
    源IP|目的IP|源MAC|目的MAC
    ---|---|---|---
    A|B|A|router
    A|B|router|B

#### 4.5.4 Others
ARP只经过链路层，不经过网络层封装

### 4.6 路由器
最高处理到网络层
#### 4.6.1 输入到输出
打碎，重构网络层首部；相对的，网桥并不打碎链路层首位部

#### 4.6.2 交换结构
将分组从一个输入端口转移到正确的输出端口
1. 内存读写 需要解决内存读写速度
2. 总线结构 需要解决总线的竞争
3. 互联网络 crossbar 可多个端口同时输出

#### 4.6.3 分组丢弃
1. 当输入侧带宽较高时，路由器处理速率较低，将会导致输入侧缓存满，无法继续存入分组，只能丢弃
2. 当采用一定的加速比时，输出侧处理速度无法与输出侧处理速度相匹配，输出侧缓存满，也会导致分组被丢弃

### 4.7 Internet的路由选择协议
#### 4.7.1 路由算法分类
- 全局性/分布式
- 静态路由选择策略/动态路由选择策略

#### 4.7.2 分层次的路由选择协议
因特网采用分层次的路由选择协议

#### 4.7.3 自治系统AS
在相同管理控制下的一组路由器
- 内部网关协议
- 外部网关协议

#### 4.7.4 内部网关协议RIP
1. 分布式 距离向量
2. 路由表的建立
    - 开始只知道相邻的路由信息（距离为1）
    - 每个路由器只和相邻路由器交换并更新路由信息
    - 若干次更新后……该自制系统的路由信息就都知道了
    - RIP协议收敛过程比较快
3. RIP的工作过程
    - 收到相邻路由器的路由表，将*该路由表*的下一跳更新，距离加一，该更新是无条件的（因为这不是最终的路由表，更新保证了时效性）
    - 与自己的路由表比较，小则替换，大则pass
    - 若3min收不到该路由器的路由表，则判断该路由器宕掉了
4. 三个要点
    - 相邻路由器交换
    - 交换的信息是当前路由器所知道的*全部信息*
    - 按固定的时间间隔交换路由信息（30s）
5. 优缺点
    1. 某个路由器的故障信息传播较慢
    2. 实现简单，开销较小
    3. 限制了网络的规模使用的最大距离为15
    4. 路由器之间交换的路由信息是完整的路由表，随着网络规模增大，开销将会增加

#### 4.7.5 最短路径优先协议OSPF
1. 基本特点  
Dijkstra算法
2. 三个要点
    - 向本自治系统所有路由器发送信息
    - 发送与本路由器相邻所有路由器的链路状态（与谁相连与链路的度量（就是权重，比如带宽、时延等））
    - 只有链路状态变化时才需要更新
3. 链路状态数据库  
就是储存的拓扑结构信息
4. OSPF的区域
    1. 如果自治系统很大，那么需要对自治系统划分为一个个区域（area）
    2. 每个区域有一个32位标志符（点分十进制）
    3. 区域不能太大，最好一个区域不超过200个路由器
    4. 两种区域：主干区域、其它
5. OSPF直接用IP数据报传送
    1. 不用UDP，直接用IP数据报，而RIP是需要先封装成UDP协议的
    2. 数据包很短，可减少路由信息的通信量
    3. 不需要分片
6. 其他特点
    1. 可以根据不同链路的类型计算不同的路由


## Extends
1. wireshark抓包工具

## Amendant Record
180913 #1 Finished  
180918 #2 Finished  
181009 #3 Finished  

## Reference
1. 申彦明老师课程
2. 《计算机网络》 谢希仁